<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Builder - Gerador de Queries</title>
    <link rel="stylesheet" href="estilos.css">
    <style>
        /* --- ESTILOS GERAIS --- */
        body { overflow: hidden; } 
        
        /* BARRA DE CONTEXTO GLOBAL */
        .global-context-bar {
            background: linear-gradient(to right, #f8fafc, #e2e8f0);
            border-bottom: 1px solid #cbd5e1;
            padding: 15px 30px;
            display: flex;
            gap: 20px;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            z-index: 10;
        }

        .global-item {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .global-item label {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 4px;
            text-transform: uppercase;
            font-weight: 700;
        }

        .global-item input {
            border: 1px solid #94a3b8;
            background: white;
            font-weight: 600;
            color: #334155;
            padding: 8px;
            border-radius: 4px;
        }
        
        .global-item input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* √ÅREA PRINCIPAL COM SCROLL */
        .scrollable-content {
            height: calc(100vh - 140px);
            overflow-y: auto;
            padding: 2rem;
            scroll-behavior: smooth;
        }

        /* FERRAMENTAS */
        .tool-container {
            display: none;
            animation: fadeIn 0.3s ease;
            max-width: 950px;
            margin: 0 auto;
        }
        .tool-container.active { display: block; }

        /* Estilos de Formul√°rio */
        .form-group { margin-bottom: 20px; }
        
        label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: #334155;
            margin-bottom: 8px;
        }

        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 10px 12px;
            font-size: 0.95rem;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            background-color: #fff;
            transition: all 0.2s;
            font-family: 'Segoe UI', sans-serif;
        }

        input:focus, select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
            outline: none;
        }

        textarea.code-editor {
            font-family: 'Consolas', 'Monaco', monospace;
            background-color: #1e293b;
            color: #e2e8f0;
            border: 1px solid #0f172a;
            min-height: 120px;
            line-height: 1.5;
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            resize: vertical;
        }

        /* Checkbox de Override */
        .override-check {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: #475569;
            background: #fff;
            padding: 8px;
            border: 1px dashed #cbd5e1;
            border-radius: 4px;
            width: fit-content;
        }
        .override-check input { width: auto; }

        /* Inputs Espec√≠ficos (Escondidos por padr√£o) */
        .specific-inputs {
            display: none;
            background: #f1f5f9;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            border: 1px solid #e2e8f0;
        }
        .specific-inputs.visible { display: block; animation: fadeIn 0.2s; }

        .btn-copy {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.1);
            color: #94a3b8;
            border: 1px solid #475569;
            padding: 4px 10px;
            font-size: 0.75rem;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-copy:hover { background: rgba(255,255,255,0.2); color: white; }

        .logic-block {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }
        .logic-block h4 { margin-top: 0; font-size: 0.9rem; color: #64748b; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px; margin-bottom: 15px; }

        /* Estilos espec√≠ficos para Linhas Din√¢micas (CASE WHEN / CONCAT) */
        .cw-row {
            display: flex;
            gap: 10px;
            align-items: center; /* Alinha verticalmente */
            margin-bottom: 10px;
            background: white;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        .cw-col { flex: 1; display: flex; flex-direction: column; gap: 5px; }
        .cw-type-selector {
            font-size: 0.75rem;
            color: var(--primary);
            font-weight: 600;
            cursor: pointer;
            text-align: right;
            user-select: none;
            margin-top: 2px;
        }
        .cw-type-selector:hover { text-decoration: underline; }

        .flex-row { display: flex; gap: 15px; }
        .flex-col { flex: 1; }
        .hidden { display: none !important; }
        
        .result-area { margin-top: 30px; position: relative; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- MOBILE ADJUSTMENTS --- */
        @media (max-width: 768px) {
            #menuToggle { display: block !important; }
            
            .global-context-bar {
                padding: 10px 15px;
                flex-wrap: wrap;
                gap: 10px;
            }
            .global-title-box { width: 100%; font-size: 0.75rem; border-bottom: 1px solid #cbd5e1; padding-bottom: 5px; }
            
            .scrollable-content { padding: 15px; height: calc(100vh - 180px); }
            
            .flex-row { flex-direction: column; gap: 15px; }
            
            .cw-row { flex-direction: column; align-items: stretch; }
            .cw-row .btn-danger { width: 100%; margin-top: 10px; height: 35px; }
            
            .logic-block .radio-group { display: flex; flex-direction: column; gap: 10px; }
            
            textarea.code-editor { font-size: 0.8rem; min-height: 150px; }
        }

    </style>
</head>
<body>

    <header>
        <div style="display: flex; align-items: center; gap: 10px;">
            <button class="btn-outline-light" id="menuToggle" style="padding: 8px; display: none;" onclick="toggleSidebar()">
                ‚ò∞
            </button>
            <div class="brand">FERRAMENTA <span>SQL Builder</span></div>
        </div>
        <div class="header-actions">
             <a href="index.html" class="btn-back">üè† Voltar</a>
        </div>
    </header>

    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <div class="workspace">
        
        <aside id="mainSidebar">
            <div class="history-container">
                <div class="history-header"><span class="history-title">Vistos Recentemente</span><button class="btn-clear-history" onclick="clearHistory()">Limpar</button></div>
                <div id="history-list" class="history-list"></div>
            </div>
            <div class="tree-container">
                <div class="tree-label">Ferramentas de Texto</div>
                <div style="margin-left: 0;">
                    <a href="#" class="node-item active" onclick="switchTool('substring', this)"><strong>SUBSTRING</strong></a>
                    <a href="#" class="node-item" onclick="switchTool('translate', this)"><strong>TRANSLATE</strong></a>
                    <a href="#" class="node-item" onclick="switchTool('concat', this)"><strong>CONCAT</strong></a>
                    <a href="#" class="node-item" onclick="switchTool('lpad', this)"><strong>LPAD</strong></a>
                </div>
                <div class="tree-label" style="margin-top: 20px;">L√≥gica & Data</div>
                <div style="margin-left: 0;">
                    <a href="#" class="node-item" onclick="switchTool('caseWhen', this)"><strong>CASE WHEN</strong></a>
                    <a href="#" class="node-item" onclick="switchTool('dateFormat', this)"><strong>FORMAT DATE</strong></a>
                </div>
                <div class="tree-label" style="margin-top: 20px;">Estrutural</div>
                <div style="margin-left: 0;">
                    <a href="#" class="node-item" onclick="switchTool('joinExpansion', this)"><strong>JOIN BUILDER</strong></a>
                </div>
            </div>
        </aside>

        <div style="flex: 1; display: flex; flex-direction: column;">
            
            <div class="global-context-bar" id="globalBar">
                <div class="global-title-box">
                    CONTEXTO GLOBAL
                </div>
                <div class="global-item" style="flex: 0 0 80px;">
                    <label>Etapa</label>
                    <input type="text" id="globalStep" placeholder="Stp">
                </div>
                <div class="global-item">
                    <label>GUID Principal</label>
                    <input type="text" id="globalGuid" placeholder="Cole o GUID...">
                </div>
            </div>

            <div class="scrollable-content">

                <div id="substringTool" class="tool-container active">
                    <div class="card">
                        <div class="card-header"><div class="card-title"><h2>SUBSTRING</h2></div></div>
                        <div style="padding: 20px;">
                            
                            <label class="override-check">
                                <input type="checkbox" id="subOverride" onchange="toggleSpecificInputs('sub')">
                                Usar campo diferente do global?
                            </label>

                            <div id="subSpecifics" class="specific-inputs">
                                <div class="form-group">
                                    <label>Origem</label>
                                    <div class="flex-row">
                                        <input type="text" id="subStepInput" placeholder="Etapa" style="flex:1">
                                        <input type="text" id="subGuidInput" placeholder="GUID" style="flex:3">
                                    </div>
                                    <input type="text" id="subVariableInput" placeholder="Ou nome da vari√°vel" style="margin-top:10px;">
                                </div>
                            </div>

                            <div class="flex-row">
                                <div class="form-group flex-col">
                                    <label>Posi√ß√£o Inicial</label>
                                    <input type="number" id="subStartInput" placeholder="1" min="1" value="1">
                                </div>
                                <div class="form-group flex-col">
                                    <label>Quantidade de Caracteres</label>
                                    <input type="number" id="subEndInput" placeholder="10" min="1">
                                </div>
                            </div>

                            <button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="generateQuery('substring')">Gerar SQL</button>
                            <div class="result-area">
                                <textarea id="subResultQuery" class="code-editor" readonly></textarea>
                                <button class="btn-copy" onclick="copyQuery('subResultQuery', this)">Copiar</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="translateTool" class="tool-container">
                    <div class="card">
                        <div class="card-header"><div class="card-title"><h2>TRANSLATE</h2></div></div>
                        <div style="padding: 20px;">
                            <label class="override-check">
                                <input type="checkbox" id="translateOverride" onchange="toggleSpecificInputs('translate')">
                                Usar campo diferente do global?
                            </label>

                            <div id="translateSpecifics" class="specific-inputs">
                                <div class="flex-row">
                                    <input type="text" id="translateStepInput" placeholder="Etapa" style="flex:1">
                                    <input type="text" id="translateGuidInput" placeholder="GUID" style="flex:3">
                                </div>
                                <input type="text" id="translateVariableInput" placeholder="Ou nome da vari√°vel" style="margin-top:10px;">
                            </div>

                            <div class="flex-row">
                                <div class="form-group flex-col">
                                    <label>Caractere(s) Antigo(s)</label>
                                    <input type="text" id="translateFromInput" placeholder="Ex: . (ponto)">
                                </div>
                                <div class="form-group flex-col">
                                    <label>Caractere(s) Novo(s)</label>
                                    <input type="text" id="translateToInput" placeholder="Ex: , (v√≠rgula) ou deixe vazio">
                                </div>
                            </div>

                            <button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="generateQuery('translate')">Gerar SQL</button>
                            <div class="result-area">
                                <textarea id="translateResultQuery" class="code-editor" readonly></textarea>
                                <button class="btn-copy" onclick="copyQuery('translateResultQuery', this)">Copiar</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="caseWhenTool" class="tool-container">
                    <div class="card">
                        <div class="card-header"><div class="card-title"><h2>CASE WHEN</h2></div></div>
                        <div style="padding: 20px;">
                            
                            <div style="background: #e0f2fe; padding: 10px; border-radius: 6px; margin-bottom: 20px; font-size: 0.9rem; color: #0369a1;">
                                ‚ÑπÔ∏è Campo base: <b>Contexto Global</b>. Voc√™ pode comparar com valores fixos ou outros campos (GUIDs).
                            </div>

                            <div id="whenClausesContainer"></div>
                            <button class="btn btn-success" onclick="addWhenClause()">+ Adicionar Condi√ß√£o</button>

                            <hr style="margin: 20px 0; border-top: 1px solid #e2e8f0;">

                            <div class="logic-block">
                                <h4>ELSE (Padr√£o)</h4>
                                <div class="radio-group">
                                    <label><input type="radio" name="elseOption" value="sameField" checked onclick="toggleElseDisplay()"> Manter Valor Base</label>
                                    <label><input type="radio" name="elseOption" value="null" onclick="toggleElseDisplay()"> NULL</label>
                                    <label><input type="radio" name="elseOption" value="custom" onclick="toggleElseDisplay()"> Valor Fixo</label>
                                    <label><input type="radio" name="elseOption" value="guid" onclick="toggleElseDisplay()"> Outro Campo</label>
                                </div>
                                
                                <div id="elseValueContainer" class="hidden" style="margin-top: 10px;">
                                    <input type="text" id="elseValueInput" placeholder="Digite o valor padr√£o...">
                                </div>
                                <div id="elseGuidContainer" class="hidden flex-row" style="margin-top: 10px;">
                                    <input type="text" id="elseStepInput" placeholder="Etapa" style="flex:1">
                                    <input type="text" id="elseGuidInput" placeholder="GUID" style="flex:3">
                                </div>
                            </div>

                            <button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="generateQuery('caseWhen')">Gerar SQL</button>
                            <div class="result-area">
                                <textarea id="caseResultQuery" class="code-editor" readonly></textarea>
                                <button class="btn-copy" onclick="copyQuery('caseResultQuery', this)">Copiar</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="concatTool" class="tool-container">
                    <div class="card">
                        <div class="card-header"><div class="card-title"><h2>CONCAT</h2></div></div>
                        <div style="padding: 20px;">
                            <p style="font-size: 0.9rem; color: #64748b; margin-bottom: 15px;">
                                Adicione partes do texto. Use "Mudar para Campo" para selecionar Steps/GUIDs.
                            </p>
                            
                            <div id="concatItemsContainer"></div>
                            <button class="btn btn-success" onclick="addConcatItem()">+ Adicionar Item</button>
                            
                            <button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="generateQuery('concat')">Gerar SQL</button>
                            <div class="result-area">
                                <textarea id="concatResultQuery" class="code-editor" readonly></textarea>
                                <button class="btn-copy" onclick="copyQuery('concatResultQuery', this)">Copiar</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="dateFormatTool" class="tool-container">
                    <div class="card">
                        <div class="card-header"><div class="card-title"><h2>FORMAT DATE</h2></div></div>
                        <div style="padding: 20px;">
                            <label class="override-check">
                                <input type="checkbox" id="dateOverride" onchange="toggleSpecificInputs('date')">
                                Usar campo diferente do global?
                            </label>

                            <div id="dateSpecifics" class="specific-inputs">
                                <div class="flex-row">
                                    <input type="text" id="dateStepInput" placeholder="Etapa" style="flex:1">
                                    <input type="text" id="dateGuidInput" placeholder="GUID" style="flex:3">
                                </div>
                            </div>

                            <div class="flex-row">
                                <div class="form-group flex-col">
                                    <label>Formato Atual (Entrada)</label>
                                    <input type="text" id="dateFormatInputMask" placeholder="Ex: YYYY-MM-DD">
                                </div>
                                <div class="form-group flex-col">
                                    <label>Formato Desejado (Sa√≠da)</label>
                                    <input type="text" id="dateFormatOutputMask" placeholder="Ex: DD/MM/YYYY">
                                </div>
                            </div>

                            <button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="generateQuery('dateFormat')">Gerar SQL</button>
                            <div class="result-area">
                                <textarea id="dateFormatResultQuery" class="code-editor" readonly></textarea>
                                <button class="btn-copy" onclick="copyQuery('dateFormatResultQuery', this)">Copiar</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="lpadTool" class="tool-container">
                    <div class="card">
                        <div class="card-header"><div class="card-title"><h2>LPAD</h2></div></div>
                        <div style="padding: 20px;">
                            <label class="override-check">
                                <input type="checkbox" id="lpadOverride" onchange="toggleSpecificInputs('lpad')">
                                Usar campo diferente do global?
                            </label>

                            <div id="lpadSpecifics" class="specific-inputs">
                                <div class="flex-row">
                                    <input type="text" id="lpadStepInput" placeholder="Etapa" style="flex:1">
                                    <input type="text" id="lpadGuidInput" placeholder="GUID" style="flex:3">
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Tamanho Final (Zeros √† esquerda ser√£o adicionados)</label>
                                <input type="number" id="lpadLengthInput" placeholder="Ex: 10" min="1">
                            </div>

                            <button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="generateQuery('lpad')">Gerar SQL</button>
                            <div class="result-area">
                                <textarea id="lpadResultQuery" class="code-editor" readonly></textarea>
                                <button class="btn-copy" onclick="copyQuery('lpadResultQuery', this)">Copiar</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="joinExpansionTool" class="tool-container">
                    <div class="card">
                        <div class="card-header"><div class="card-title"><h2>JOIN BUILDER</h2></div></div>
                        <div style="padding: 20px;">
                            <p style="color: #64748b; font-size: 0.9rem;">Cria o snippet de JOIN.</p>
                            
                            <div class="form-group">
                                <label>Tenant (Schema)</label>
                                <input type="text" id="joinTenantInput" placeholder="Ex: 4mdg">
                            </div>
                            
                            <div class="flex-row">
                                <div class="form-group flex-col">
                                    <label>Alias (Apelido Tabela)</label>
                                    <input type="text" id="joinAliasInput" placeholder="Ex: ans_mat">
                                </div>
                                <div class="form-group flex-col">
                                    <label>GUID da Etapa</label>
                                    <input type="text" id="joinGuidInput" placeholder="Usa o Global se vazio">
                                </div>
                            </div>

                            <button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="generateQuery('joinExpansion')">Gerar SQL</button>
                            <div class="result-area">
                                <textarea id="joinResultQuery" class="code-editor" readonly></textarea>
                                <button class="btn-copy" onclick="copyQuery('joinResultQuery', this)">Copiar</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- NAVEGA√á√ÉO ---
        function toggleSidebar() {
            document.getElementById('mainSidebar').classList.toggle('open');
            document.getElementById('sidebarOverlay').classList.toggle('open');
        }

        function switchTool(toolId, element) {
            document.querySelectorAll('.node-item').forEach(el => el.classList.remove('active'));
            if(element) element.classList.add('active');
            document.querySelectorAll('.tool-container').forEach(el => el.classList.remove('active'));
            const target = document.getElementById(toolId + 'Tool');
            if(target) target.classList.add('active');

            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
        }

        function toggleSpecificInputs(prefix) {
            const check = document.getElementById(prefix + 'Override');
            const area = document.getElementById(prefix + 'Specifics');
            if(check && area) {
                if(check.checked) area.classList.add('visible');
                else area.classList.remove('visible');
            }
        }

        // --- SISTEMA DE CONTEXTO GLOBAL ---
        function getGlobalContext() {
            return {
                step: document.getElementById('globalStep').value.trim(),
                guid: document.getElementById('globalGuid').value.trim()
            };
        }

        function getBaseField(prefix) {
            const override = document.getElementById(prefix + 'Override')?.checked;
            
            if (override) {
                const variable = document.getElementById(prefix + 'VariableInput')?.value;
                if(variable) return variable;

                const step = document.getElementById(prefix + 'StepInput')?.value;
                const guid = document.getElementById(prefix + 'GuidInput')?.value;
                if(step && guid) return `ans${step}.data->'values'->>'${guid}'`;
            }

            const global = getGlobalContext();
            if (global.step && global.guid) {
                return `ans${global.step}.data->'values'->>'${global.guid}'`;
            }

            return null;
        }

        // --- L√ìGICA DE UI (CASE WHEN / CONCAT / INPUT TOGGLE) ---
        
        // Alterna entre Input Texto e Inputs de Campo (Step/GUID)
        function toggleInputType(element, type) {
            const parent = element.parentElement; // .cw-col
            const input = parent.querySelector(`.${type}-input`);
            const fields = parent.querySelector('.field-inputs');

            // Para CONCAT queremos permitir tamb√©m valores fixos mesmo quando
            // o usu√°rio opta por 'Campo'. Assim, n√£o escondemos o input de texto
            // para concat; apenas mostramos/ocultamos os campos Step/GUID e
            // atualizamos o data-type para orientar a gera√ß√£o.
            const btnText = (element.innerText || '').toLowerCase();
            const wantsField = btnText.indexOf('campo') !== -1; // aceita 'Mudar p/ Campo' e 'Mudar para Campo'

            if (wantsField) {
                // comportamento unificado: ao mudar para Campo, esconder input
                // de texto e mostrar os campos Step/GUID. Limpa o input para
                // evitar que o mesmo valor seja considerado duas vezes.
                if (input) {
                    input.classList.add('hidden');
                    try { input.value = ''; } catch(e) {}
                }
                if (fields) fields.classList.remove('hidden');
                element.innerText = "Mudar para Valor";
                parent.dataset.type = 'field'; 
            } else {
                // Ao voltar para Valor, mostra o input de texto e esconde campos
                // Step/GUID; limpa os campos Step/GUID para evitar res√≠duos.
                if (input) input.classList.remove('hidden');
                if (fields) {
                    fields.classList.add('hidden');
                    const s = fields.querySelectorAll('input');
                    s.forEach(i => i.value = '');
                }
                element.innerText = "Mudar para Campo";
                parent.dataset.type = 'value'; 
            }
        }

        function toggleElseDisplay() {
            const opt = document.querySelector('input[name="elseOption"]:checked').value;
            document.getElementById('elseValueContainer').classList.add('hidden');
            document.getElementById('elseGuidContainer').classList.add('hidden');
            
            if(opt === 'custom') document.getElementById('elseValueContainer').classList.remove('hidden');
            if(opt === 'guid') {
                const el = document.getElementById('elseGuidContainer');
                el.classList.remove('hidden');
                el.style.display = 'flex';
            }
        }

        let whenCounter = 0;
        function addWhenClause() {
            whenCounter++;
            const container = document.getElementById('whenClausesContainer');
            const div = document.createElement('div');
            div.className = 'cw-row';
            div.id = `cw-row-${whenCounter}`;
            div.innerHTML = `
                <div class="cw-col">
                    <label>Se valor for igual a:</label>
                    <input type="text" class="when-input" placeholder="Valor fixo...">
                    <div class="cw-type-selector" onclick="toggleInputType(this, 'when')">Mudar para Campo</div>
                    <div class="hidden field-inputs">
                        <div style="display:flex; gap:5px;">
                            <input type="text" class="when-step" placeholder="Stp" style="width: 40px;">
                            <input type="text" class="when-guid" placeholder="GUID" style="flex:1;">
                        </div>
                    </div>
                </div>
                
                <div class="cw-col">
                    <label>Ent√£o:</label>
                    <input type="text" class="then-input" placeholder="Resultado fixo...">
                    <div class="cw-type-selector" onclick="toggleInputType(this, 'then')">Mudar para Campo</div>
                    <div class="hidden field-inputs">
                        <div style="display:flex; gap:5px;">
                            <input type="text" class="then-step" placeholder="Stp" style="width: 40px;">
                            <input type="text" class="then-guid" placeholder="GUID" style="flex:1;">
                        </div>
                    </div>
                </div>

                <button class="btn btn-danger" onclick="this.parentElement.remove()" style="margin-top: 24px;">‚úï</button>
            `;
            container.appendChild(div);
        }

        function addConcatItem() {
            const container = document.getElementById('concatItemsContainer');
            const div = document.createElement('div');
            div.className = 'cw-row concat-item';
            div.innerHTML = `
                <div class="cw-col" data-type="value" style="flex-direction: row; align-items: center; gap: 10px; width: 100%;">
                    <div style="flex: 1;">
                        <input type="text" class="concat-input" placeholder="Texto, 'GLOBAL' ou Vari√°vel...">
                        <div class="hidden field-inputs" style="display:flex; gap:5px;">
                            <input type="text" class="concat-step" placeholder="Stp" style="width: 50px;">
                            <input type="text" class="concat-guid" placeholder="GUID" style="flex: 1;">
                        </div>
                    </div>
                    <div class="cw-type-selector" onclick="toggleInputType(this, 'concat')" style="width: 100px; text-align: center;">Mudar p/ Campo</div>
                    <button class="btn btn-danger" onclick="this.parentElement.parentElement.remove()">‚úï</button>
                </div>
            `;
            container.appendChild(div);
        }

        // --- GERADOR CORE ---
        function generateQuery(type) {
            let result = '';
            const outputId = type === 'joinExpansion' ? 'joinResultQuery' : 
                             type === 'caseWhen' ? 'caseResultQuery' : 
                             type === 'substring' ? 'subResultQuery' : 
                             type + 'ResultQuery';
            
            const output = document.getElementById(outputId);
            if(!output) return;

            try {
                // 1. SUBSTRING
                if (type === 'substring') {
                    const field = getBaseField('sub');
                    const start = document.getElementById('subStartInput').value;
                    const end = document.getElementById('subEndInput').value;
                    if(!field) throw new Error("Preencha o Contexto Global ou use Override.");
                    result = `substring(${field}, ${start}, ${end})`;
                }
                
                // 2. TRANSLATE
                else if (type === 'translate') {
                    const field = getBaseField('translate');
                    const from = document.getElementById('translateFromInput').value;
                    const to = document.getElementById('translateToInput').value;
                    if(!field) throw new Error("Campo origem inv√°lido.");
                    result = `translate(${field}, '${from}', '${to}')`;
                }

                // 3. CONCAT (Atualizado com toggle)
                else if (type === 'concat') {
                    const items = document.querySelectorAll('.concat-item');
                    let parts = [];
                    items.forEach(item => {
                        const col = item.querySelector('.cw-col'); // Pega o container do input
                        const isField = col.dataset.type === 'field';

                        if (isField) {
                            const s = (col.querySelector('.concat-step') || {}).value || '';
                            const g = (col.querySelector('.concat-guid') || {}).value || '';
                            if (s && g) {
                                parts.push(`ans${s}.data->'values'->>'${g}'`);
                                return;
                            }
                            // Se n√£o informou step/guid, permite fallback para valor fixo
                        }

                        // Tenta ler o valor puro (sem trim) para respeitar espa√ßos
                        const rawInput = (col.querySelector('.concat-input') || {}).value || '';
                        const raw = rawInput; // mant√©m espa√ßos intencionais
                        if (raw.length === 0) return; // ignora item vazio

                        // Token GLOBAL refere-se ao contexto base
                        if (raw === 'GLOBAL') {
                            const g = getBaseField('fake'); // tenta pegar global
                            if (g) parts.push(g);
                            return;
                        }

                        const startsWithAns = raw.startsWith('ans');
                        const startsWithQuote = raw.startsWith("'") || raw.startsWith('"');
                        if (startsWithAns || startsWithQuote) {
                            parts.push(raw);
                        } else {
                            // Escapa aspas simples para SQL e envolve em aspas
                            const escaped = raw.replace(/'/g, "''");
                            parts.push(`'${escaped}'`);
                        }
                    });
                    if (parts.length > 0) result = `CONCAT(${parts.join(', ')})`;
                }

                // 4. LPAD
                else if (type === 'lpad') {
                    const field = getBaseField('lpad');
                    const len = document.getElementById('lpadLengthInput').value;
                    if(!field || !len) throw new Error("Preencha os campos.");
                    result = `CASE\n    WHEN ${field} != '' THEN lpad(${field}, ${len}, '0')\n    ELSE ${field}\nEND`;
                }

                // 5. DATE FORMAT
                else if (type === 'dateFormat') {
                    const field = getBaseField('date');
                    const maskIn = document.getElementById('dateFormatInputMask').value;
                    const maskOut = document.getElementById('dateFormatOutputMask').value;
                    if(!field) throw new Error("Campo data inv√°lido.");
                    result = `to_char(to_timestamp(${field}, '${maskIn}'), '${maskOut}')`;
                }

                // 6. JOIN
                else if (type === 'joinExpansion') {
                    const t = document.getElementById('joinTenantInput').value;
                    const a = document.getElementById('joinAliasInput').value;
                    let g = document.getElementById('joinGuidInput').value;
                    if(!g) g = getGlobalContext().guid; // Fallback
                    if(!t || !a || !g) throw new Error("Preencha Tenant, Alias e GUID.");
                    result = `JOIN ${t}.answers ${a} ON ${a}.step_id = '${g}'\n    AND ${a}.concluded_at IS NOT NULL\n    AND ${a}.deleted_at IS NULL`;
                }

                // 7. CASE WHEN (Atualizado com toggle)
                else if (type === 'caseWhen') {
                    const field = getBaseField('case');
                    let base = field;
                    if(!base) {
                        const g = getGlobalContext();
                        if(g.step && g.guid) base = `ans${g.step}.data->'values'->>'${g.guid}'`;
                        else throw new Error("Defina o Contexto Global (Etapa e GUID) primeiro.");
                    }

                    let lines = [`CASE`];
                    
                    // iterar apenas sobre as linhas dentro do container de WHEN
                    document.querySelectorAll('#whenClausesContainer .cw-row').forEach(row => {
                        // L√≥gica da Esquerda (WHEN)
                        let leftVal = '';
                        const whenCol = row.querySelector('.cw-col:first-child');
                        if (whenCol.dataset.type === 'field') {
                            const s = whenCol.querySelector('.when-step').value;
                            const g = whenCol.querySelector('.when-guid').value;
                            if(s && g) leftVal = `ans${s}.data->'values'->>'${g}'`;
                        } else {
                            const val = whenCol.querySelector('.when-input').value;
                            if(val) leftVal = `'${val}'`;
                        }

                        // L√≥gica da Direita (THEN)
                        let rightVal = '';
                        const thenCol = row.querySelector('.cw-col:nth-child(2)');
                        if (thenCol.dataset.type === 'field') {
                            const s = thenCol.querySelector('.then-step').value;
                            const g = thenCol.querySelector('.then-guid').value;
                            if(s && g) rightVal = `ans${s}.data->'values'->>'${g}'`;
                        } else {
                            const val = thenCol.querySelector('.then-input').value;
                            if(val) rightVal = `'${val}'`;
                        }

                        if(leftVal && rightVal) {
                            // Se comparando campo com campo, remove as aspas da compara√ß√£o
                            lines.push(`    WHEN ${base} = ${leftVal} THEN ${rightVal}`);
                        }
                    });

                    // ELSE
                    const elseOpt = document.querySelector('input[name="elseOption"]:checked').value;
                    let elseVal = 'NULL';
                    if(elseOpt === 'sameField') elseVal = base;
                    else if(elseOpt === 'custom') elseVal = `'${document.getElementById('elseValueInput').value}'`;
                    else if(elseOpt === 'guid') {
                        const s = document.getElementById('elseStepInput').value;
                        const g = document.getElementById('elseGuidInput').value;
                        if(s && g) elseVal = `ans${s}.data->'values'->>'${g}'`;
                    }
                    
                    lines.push(`    ELSE ${elseVal}`);
                    lines.push('END');
                    result = lines.join('\n');
                }

                output.value = result;

            } catch(e) {
                alert(e.message);
            }
        }

        function copyQuery(id, btn) {
            const text = document.getElementById(id).value;
            if(!text) return;
            navigator.clipboard.writeText(text).then(() => {
                const original = btn.innerText;
                btn.innerText = "OK";
                setTimeout(() => btn.innerText = original, 1000);
            });
        }

        // Init
        addWhenClause();
        addConcatItem(); 
        addConcatItem(); 
    </script>

    <script>
        // --- HIST√ìRICO DE NAVEGA√á√ÉO ---
        (function() {
            const MAX_HISTORY = 10;
            const HISTORY_KEY = 'sap_docs_history';
            if (!window.location.pathname.endsWith('index.html')) {
                const pageTitle = document.title.split('-')[0].trim();
                const currentPage = { title: pageTitle, url: window.location.pathname.split('/').pop() };
                let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
                history = history.filter(h => h.url !== currentPage.url);
                history.unshift(currentPage);
                if (history.length > MAX_HISTORY) history.pop();
                localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            }
            const container = document.getElementById('history-list');
            if (container) {
                const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
                if (history.length === 0) container.innerHTML = '<div style="padding:5px 12px; font-size:0.75rem; color:#64748b;">Nenhum item recente.</div>';
                else { container.innerHTML = history.map(h => `<a href="${h.url}" class="history-link">${h.title}</a>`).join(''); }
            }
            window.clearHistory = function() { localStorage.removeItem(HISTORY_KEY); if(document.getElementById('history-list')) document.getElementById('history-list').innerHTML = ''; }
        })();
    </script>
</body>
</html>