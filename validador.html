<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validador de Dados SAP</title>
    <link rel="stylesheet" href="estilos.css">
    <script src="dados_campos.js"></script> 
    <style>
        /* --- ESTILOS ESPEC√çFICOS DO VALIDADOR (Recuperados) --- */
        .validator-wrapper {
            max-width: 800px;
            margin: 40px auto;
            padding: 0 20px 50px 20px;
        }

        .validator-card {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
        }

        .val-title {
            margin-top: 0;
            color: #1e293b;
            font-size: 1.5rem;
            font-weight: 700;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        /* Input Groups */
        .val-search-box {
            background: #eff6ff; /* Azul bem claro */
            border: 1px solid #dbeafe;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .val-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 700;
            color: #64748b;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .val-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Consolas', monospace;
            transition: all 0.2s;
            color: #334155;
        }

        .val-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            outline: none;
        }

        .val-input:disabled {
            background-color: #f1f5f9;
            color: #94a3b8;
            cursor: not-allowed;
        }

        .val-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .val-col { flex: 1; }

        .helper-text {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 8px;
        }

        /* Resultado & Status */
        .result-box {
            margin-top: 30px;
            padding: 20px;
            border-radius: 12px;
            background: #f8fafc;
            border: 1px solid var(--border);
            display: none; /* Escondido por padr√£o */
            flex-direction: column;
            gap: 15px;
            animation: fadeIn 0.3s ease;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            font-weight: 700;
            font-size: 1rem;
            gap: 8px;
        }
        .status-valid { color: #166534; }
        .status-invalid { color: #991b1b; }

        .payload-output {
            background: #1e293b; /* Dark mode code */
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Consolas', monospace;
            font-size: 1.1rem;
            position: relative;
            word-break: break-all;
        }

        .copy-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }
        .copy-btn:hover { background: rgba(255,255,255,0.2); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- MOBILE ADJUSTMENTS --- */
        @media (max-width: 768px) {
            .validator-wrapper {
                margin: 10px auto;
                padding: 0 10px 30px 10px;
            }

            .validator-card {
                padding: 20px;
                border-radius: 12px;
            }

            .val-title {
                font-size: 1.25rem;
                padding-bottom: 15px;
                margin-bottom: 20px;
            }

            .val-row {
                flex-direction: column;
                gap: 15px;
            }

            .val-search-box {
                padding: 15px;
                margin-bottom: 20px;
            }

            .payload-output {
                font-size: 1rem;
                padding: 15px 10px;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .copy-btn {
                position: static;
                transform: none;
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body>

    <header>
        <div class="brand">FERRAMENTA <span>Validador SAP</span></div>
        <div class="header-actions">
             <a href="index.html" class="btn-back">üè† Voltar</a>
        </div>
    </header>

    <div class="workspace">
        <aside>
            <div class="history-container">
                <div class="history-header"><span class="history-title">Vistos Recentemente</span><button class="btn-clear-history" onclick="clearHistory()">Limpar</button></div>
                <div id="history-list" class="history-list"></div>
            </div>
        </aside>
        <main style="flex:1; overflow-y:auto;">
            <div class="validator-wrapper">
        <div class="validator-card">
            <h2 class="val-title">Simulador de Campo SAP</h2>

            <div class="val-search-box">
                <label class="val-label" style="color: #1e40af;">üîé Buscar Campo do Projeto</label>
                <input list="fieldsList" id="fieldSearch" class="val-input" placeholder="Digite o nome (ex: MATNR, KUNNR) para configurar..." onchange="autoConfigure()">
                <datalist id="fieldsList"></datalist>
                <div id="fieldDesc" style="font-size: 0.9rem; color: #3b82f6; margin-top: 8px; font-weight: 500;"></div>
            </div>

            <div class="val-row">
                <div class="val-col">
                    <label class="val-label">Tipo de Dado</label>
                    <input type="text" id="dataTypeDisplay" class="val-input" readonly value="--">
                </div>
                <div class="val-col">
                    <label class="val-label">Tamanho (Length)</label>
                    <input type="number" id="dataLen" class="val-input" readonly value="0">
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <label class="val-label">Valor de Entrada</label>
                <input type="text" id="inputVal" class="val-input" placeholder="Selecione um campo acima primeiro..." disabled oninput="validate()">
                <div id="typeHint" class="helper-text"></div>
            </div>

            <div id="resultBox" class="result-box">
                <div id="statusText" class="status-badge"></div>
                <div id="msgText" style="font-size: 0.9rem; color: #475569;"></div>
                
                <label class="val-label" style="margin-top: 10px;">Valor Formatado (Payload JSON/XML):</label>
                <div class="payload-output">
                    <span id="formattedVal"></span>
                    <button class="copy-btn" onclick="copyResult()">Copiar</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- INICIALIZA√á√ÉO ---
        window.onload = function() {
            const list = document.getElementById('fieldsList');
            // Verifica se o arquivo JS foi carregado corretamente
            if(typeof GLOBAL_FIELDS !== 'undefined') {
                for (const [key, val] of Object.entries(GLOBAL_FIELDS)) {
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.textContent = `${val.desc} (${val.type}, ${val.len})`;
                    list.appendChild(opt);
                }
            } else {
                document.getElementById('fieldDesc').innerHTML = "<span style='color:red'>Erro: Arquivo de dados n√£o carregado. Rode o script Python novamente.</span>";
            }
        };

        function autoConfigure() {
            const fieldName = document.getElementById('fieldSearch').value.trim();
            const descEl = document.getElementById('fieldDesc');
            const typeDisplay = document.getElementById('dataTypeDisplay');
            const lenInput = document.getElementById('dataLen');
            const inputVal = document.getElementById('inputVal');

            if (fieldName && typeof GLOBAL_FIELDS !== 'undefined' && GLOBAL_FIELDS[fieldName]) {
                const data = GLOBAL_FIELDS[fieldName];
                
                // Configura a UI
                descEl.innerText = data.desc;
                typeDisplay.value = data.type; // ex: CHAR
                lenInput.value = data.len;
                
                // Habilita entrada
                inputVal.disabled = false;
                inputVal.placeholder = `Digite o valor para ${fieldName}...`;
                inputVal.focus();
                
                // Limpa resultado anterior
                document.getElementById('resultBox').style.display = 'none';
                inputVal.value = '';
                document.getElementById('typeHint').innerText = "";
            } else {
                descEl.innerText = "Campo n√£o encontrado ou busca vazia.";
                typeDisplay.value = "--";
                lenInput.value = 0;
                inputVal.disabled = true;
                inputVal.placeholder = "Selecione um campo acima primeiro...";
            }
        }

        function validate() {
            const type = document.getElementById('dataTypeDisplay').value;
            const len = parseInt(document.getElementById('dataLen').value) || 0;
            const input = document.getElementById('inputVal').value;
            
            const resultBox = document.getElementById('resultBox');
            const statusText = document.getElementById('statusText');
            const msgText = document.getElementById('msgText');
            const formattedVal = document.getElementById('formattedVal');
            const hint = document.getElementById('typeHint');

            if (!input) { resultBox.style.display = 'none'; return; }
            resultBox.style.display = 'flex';

            let finalValue = input;
            let isValid = true;

            // L√≥gica de valida√ß√£o
            if (type.includes('CHAR') || type.includes('LANG')) {
                hint.innerText = `Texto livre. M√°ximo ${len} caracteres.`;
                if (input.length > len) {
                    statusText.innerHTML = '‚ö†Ô∏è Tamanho Excedido';
                    statusText.className = 'status-badge status-invalid';
                    msgText.innerText = `O texto ser√° cortado (Truncated) para ${len} caracteres.`;
                    finalValue = input.substring(0, len);
                } else {
                    statusText.innerHTML = '‚úÖ V√°lido';
                    statusText.className = 'status-badge status-valid';
                    msgText.innerText = "Formato aceito pelo SAP.";
                }
            }
            else if (type.includes('NUMC') || type.includes('INT')) {
                hint.innerText = "Apenas n√∫meros. O sistema adicionar√° zeros √† esquerda automaticamente.";
                const numeric = input.replace(/\D/g, '');
                
                if (!numeric && input.length > 0) {
                    statusText.innerHTML = '‚ùå Inv√°lido'; 
                    statusText.className = 'status-badge status-invalid';
                    msgText.innerText = "O campo cont√©m letras ou s√≠mbolos n√£o permitidos.";
                    finalValue = "ERRO";
                } else if (numeric.length > len) {
                    statusText.innerHTML = '‚ùå Estouro'; 
                    statusText.className = 'status-badge status-invalid';
                    msgText.innerText = `O valor ${numeric} √© maior que o permitido (${len} d√≠gitos).`;
                    finalValue = numeric;
                } else {
                    statusText.innerHTML = '‚úÖ V√°lido (Zeros adicionados)'; 
                    statusText.className = 'status-badge status-valid';
                    msgText.innerText = "Formatado para o padr√£o SAP (Leading Zeros).";
                    finalValue = numeric.padStart(len, '0');
                }
            }
            else if (type.includes('DATS')) {
                hint.innerText = "Datas devem ser enviadas como YYYYMMDD.";
                let clean = input.replace(/[\/\-\.]/g, '');
                
                // Regex simples para tentar validar
                if (clean.length === 8 && !isNaN(clean)) {
                    // Tenta adivinhar se √© DDMMYYYY (Dia > 12 ou Ano no fim)
                    const firstPart = parseInt(clean.substring(0,2));
                    const lastPart = parseInt(clean.substring(4,8));
                    
                    if (lastPart > 2000 && lastPart < 2100) { 
                        // Parece DDMMYYYY (ex: 31122025)
                        const d = clean.substring(0,2); 
                        const m = clean.substring(2,4); 
                        const y = clean.substring(4,8);
                        finalValue = y + m + d;
                        statusText.innerHTML = '‚úÖ Convertido'; 
                        statusText.className = 'status-badge status-valid';
                        msgText.innerText = "Detectado DDMMYYYY e convertido para YYYYMMDD.";
                    } else if (parseInt(clean.substring(0,4)) > 1900) {
                        // Parece j√° ser YYYYMMDD
                        finalValue = clean;
                        statusText.innerHTML = '‚úÖ V√°lido'; 
                        statusText.className = 'status-badge status-valid';
                        msgText.innerText = "Formato correto.";
                    } else {
                        statusText.innerHTML = '‚ùì Amb√≠guo'; 
                        statusText.className = 'status-badge status-invalid';
                        msgText.innerText = "N√£o foi poss√≠vel determinar o formato com certeza.";
                    }
                } else {
                    statusText.innerHTML = '‚ùå Data Inv√°lida'; 
                    statusText.className = 'status-badge status-invalid';
                    msgText.innerText = "O SAP exige 8 d√≠gitos num√©ricos.";
                }
            }
            
            formattedVal.innerText = finalValue;
        }

        function copyResult() {
            navigator.clipboard.writeText(document.getElementById('formattedVal').innerText);
            const btn = document.querySelector('.copy-btn');
            const originalText = btn.innerText;
            btn.innerText = "Copiado!";
            setTimeout(() => btn.innerText = originalText, 1500);
        }
        
        
        
    </script>
        </main>
    </div>

    <script>
        // --- HIST√ìRICO DE NAVEGA√á√ÉO ---
        (function() {
            const MAX_HISTORY = 10;
            const HISTORY_KEY = 'sap_docs_history';
            if (!window.location.pathname.endsWith('index.html')) {
                const pageTitle = document.title.split('-')[0].trim();
                const currentPage = { title: pageTitle, url: window.location.pathname.split('/').pop() };
                let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
                history = history.filter(h => h.url !== currentPage.url);
                history.unshift(currentPage);
                if (history.length > MAX_HISTORY) history.pop();
                localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            }
            const container = document.getElementById('history-list');
            if (container) {
                const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
                if (history.length === 0) container.innerHTML = '<div style="padding:5px 12px; font-size:0.75rem; color:#64748b;">Nenhum item recente.</div>';
                else { container.innerHTML = history.map(h => `<a href="${h.url}" class="history-link">${h.title}</a>`).join(''); }
            }
            window.clearHistory = function() { localStorage.removeItem(HISTORY_KEY); if(document.getElementById('history-list')) document.getElementById('history-list').innerHTML = ''; }
        })();
    </script>
</body>
</html>