<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Diff - Portal SAP</title>
    <link rel="stylesheet" href="estilos.css">
    <style>
        .diff-container {
            display: flex;
            height: calc(100vh - 70px);
            overflow: hidden;
            background: #f8fafc;
        }

        .input-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            border-right: 1px solid var(--border);
        }

        .result-column {
            flex: 1.5;
            display: flex;
            flex-direction: column;
            padding: 20px;
            background: white;
            overflow-y: auto;
        }

        .json-input {
            flex: 1;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            resize: none;
            margin-bottom: 10px;
        }

        .diff-controls {
            display: flex;
            justify-content: center;
            padding: 10px;
            background: white;
            border-bottom: 1px solid var(--border);
            gap: 15px;
        }

        .btn-compare {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            font-size: 1rem;
        }

        .btn-compare:hover { background: #1e40af; }

        /* Estilos do Relat√≥rio Diff */
        .diff-node {
            font-family: 'Consolas', monospace;
            font-size: 0.9rem;
            padding: 4px 0;
            margin-left: 20px;
        }

        .diff-added { background-color: #dcfce7; color: #166534; padding: 2px 4px; border-radius: 4px; }
        .diff-removed { background-color: #fee2e2; color: #991b1b; padding: 2px 4px; border-radius: 4px; }
        .diff-changed { background-color: #fef9c3; color: #854d0e; padding: 2px 4px; border-radius: 4px; }
        
        .key { color: #475569; font-weight: 600; }
        .bracket { color: #94a3b8; }

        .summary-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f1f5f9;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        
        .badge-count { font-weight: 700; padding: 2px 8px; border-radius: 10px; margin-left: 5px; }
        .bg-green { background: #dcfce7; color: #166534; }
        .bg-red { background: #fee2e2; color: #991b1b; }
        .bg-yellow { background: #fef9c3; color: #854d0e; }

        /* --- MOBILE DIFF --- */
        .mobile-nav-diff {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: white;
            border-top: 1px solid var(--border);
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
        }

        .mnd-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            border: none;
            background: transparent;
            color: #64748b;
            font-weight: 600;
            font-size: 0.75rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .mnd-btn.active {
            color: var(--brand-blue);
            background: #f8fafc;
        }

        @media (max-width: 768px) {
            .diff-controls {
                flex-direction: column;
                gap: 10px;
                padding: 15px;
            }
            .diff-controls button { width: 100%; }

            .diff-container {
                flex-direction: column;
                height: calc(100vh - 180px); /* Espa√ßo para header + controls + nav */
                padding-bottom: 60px;
            }

            .input-column, .result-column {
                display: none; /* Esconde todos */
                width: 100%;
                height: 100%;
                border-right: none;
            }

            .input-column.mobile-active, .result-column.mobile-active {
                display: flex;
            }

            .mobile-nav-diff { display: flex; }
            
            .summary-bar {
                flex-wrap: wrap;
                gap: 10px;
            }
        }

    </style>
</head>
<body>

    <header>
        <div class="brand">FERRAMENTA <span>JSON Diff</span></div>
        <div class="header-actions">
            <a href="index.html" class="btn-back">üè† Voltar</a>
        </div>
    </header>

    <div class="workspace">
        <aside>
            <div class="history-container">
                <div class="history-header"><span class="history-title">Vistos Recentemente</span><button class="btn-clear-history" onclick="clearHistory()">Limpar</button></div>
                <div id="history-list" class="history-list"></div>
            </div>
        </aside>
        <div style="flex:1; display:flex; flex-direction:column; overflow:hidden;">
            <div class="diff-controls">
        <div style="display:flex; align-items:center; gap:10px;">
            <label><input type="checkbox" id="chkIgnoreOrder" checked> Ignorar Ordem (Arrays/Objetos)</label>
        </div>
        <button class="btn-compare" onclick="compareJSONs()">COMPARAR VERS√ïES ‚ö°</button>
    </div>

    <div class="diff-container">
        
        <div class="input-column mobile-active" id="colA">
            <h3>Vers√£o A (Original)</h3>
            <textarea id="jsonA" class="json-input" placeholder='cole o JSON antigo aqui... {"id":1}'></textarea>
        </div>

        <div class="input-column" id="colB">
            <h3>Vers√£o B (Nova)</h3>
            <textarea id="jsonB" class="json-input" placeholder='cole o JSON novo aqui... {"id":2}'></textarea>
        </div>

        <div class="result-column" id="colRes">
            <h3>Relat√≥rio de Diferen√ßas</h3>
            <div id="diffSummary" class="summary-bar" style="display:none;">
                <span>Adicionados: <span id="countAdd" class="badge-count bg-green">0</span></span>
                <span>Removidos: <span id="countRem" class="badge-count bg-red">0</span></span>
                <span>Alterados: <span id="countChange" class="badge-count bg-yellow">0</span></span>
            </div>
            <div id="diffOutput"></div>
        </div>

        </div>
    </div>

    <nav class="mobile-nav-diff">
        <button class="mnd-btn active" onclick="switchDiffTab('A')">
            <span style="font-size:1.2rem;">üÖ∞Ô∏è</span> Original
        </button>
        <button class="mnd-btn" onclick="switchDiffTab('B')">
            <span style="font-size:1.2rem;">üÖ±Ô∏è</span> Novo
        </button>
        <button class="mnd-btn" onclick="switchDiffTab('Res')">
            <span style="font-size:1.2rem;">‚öñÔ∏è</span> Resultado
        </button>
    </nav>

    <script>
        // --- LIB DE COMPARA√á√ÉO (Deep Diff Customizado) ---
        
        let stats = { added: 0, removed: 0, changed: 0 };

        function compareJSONs() {
            try {
                const strA = document.getElementById('jsonA').value;
                const strB = document.getElementById('jsonB').value;
                const output = document.getElementById('diffOutput');
                const ignoreOrder = document.getElementById('chkIgnoreOrder').checked;

                stats = { added: 0, removed: 0, changed: 0 };
                output.innerHTML = '';

                let objA, objB;
                
                if (!strA || !strB) {
                    output.innerHTML = '<div style="color:#b91c1c; padding:20px;">‚ö†Ô∏è Por favor, preencha os dois campos de JSON.</div>';
                    return;
                }

                try {
                    objA = JSON.parse(strA);
                    objB = JSON.parse(strB);
                } catch (e) {
                    output.innerHTML = `<div style="color:red; padding:20px;">‚ùå Erro de Sintaxe JSON: ${e.message}</div>`;
                    return;
                }

                console.log("Iniciando compara√ß√£o...");
                const diffHTML = generateDiffHtml(objA, objB, ignoreOrder);
                console.log("Compara√ß√£o finalizada. HTML gerado:", diffHTML ? "Sim" : "Vazio");
                
                if (!diffHTML) {
                    output.innerHTML = '<div style="padding:20px; color:#166534; font-weight:bold;">‚úÖ Vers√µes Id√™nticas (Nenhuma diferen√ßa de conte√∫do encontrada).</div>';
                } else {
                    output.innerHTML = diffHTML;
                }
                
                // No mobile, ap√≥s comparar, pula para a aba de resultado
                if (window.innerWidth <= 768) {
                    switchDiffTab('Res');
                }

                // Atualiza barra de resumo
                document.getElementById('diffSummary').style.display = 'flex';
                document.getElementById('countAdd').innerText = stats.added;
                document.getElementById('countRem').innerText = stats.removed;
                document.getElementById('countChange').innerText = stats.changed;

            } catch (err) {
                console.error(err);
                document.getElementById('diffOutput').innerHTML = `<div style="color:red; padding:20px;">üî• Erro Cr√≠tico na Compara√ß√£o: ${err.message}<br><small>Verifique o console (F12) para detalhes.</small></div>`;
            }
        }

        function switchDiffTab(tab) {
            // Colunas
            document.querySelectorAll('.input-column, .result-column').forEach(el => el.classList.remove('mobile-active'));
            document.getElementById('col' + tab).classList.add('mobile-active');
            
            // Bot√µes
            document.querySelectorAll('.mnd-btn').forEach(btn => btn.classList.remove('active'));
            const idx = tab === 'A' ? 0 : tab === 'B' ? 1 : 2;
            document.querySelectorAll('.mnd-btn')[idx].classList.add('active');
        }

        function generateDiffHtml(valA, valB, ignoreOrder) {
            
            // 0. Tratamento expl√≠cito de NULL (typeof null === 'object' bug do JS)
            if (valA === null || valB === null) {
                if (valA !== valB) {
                    stats.changed++;
                    return `<div class="diff-node"><span class="diff-changed">MUDOU VALOR:</span> ${JSON.stringify(valA)} ‚ûî ${JSON.stringify(valB)}</div>`;
                }
                return '';
            }

            // 1. Tipos diferentes (Change)
            if (getType(valA) !== getType(valB)) {
                stats.changed++;
                return `<div class="diff-node"><span class="diff-changed">MUDOU TIPO:</span> ${JSON.stringify(valA)} ‚ûî ${JSON.stringify(valB)}</div>`;
            }

            // 2. Valores Primitivos (String, Number, Boolean)
            if (isPrimitive(valA)) {
                if (valA !== valB) {
                    stats.changed++;
                    return `<div class="diff-node"><span class="diff-changed">VALOR:</span> ${valA} ‚ûî ${valB}</div>`;
                }
                return ''; // Iguais, n√£o mostra nada
            }

            // 3. Arrays
            if (Array.isArray(valA)) {
                let html = '<div class="diff-node"><span class="bracket">[</span>';
                
                if (ignoreOrder) {
                    // L√ìGICA MELHORADA:
                    // Se forem arrays de objetos, tentar casar por "melhor similaridade" √© muito custoso (O(n^2)).
                    // Vamos tentar uma abordagem h√≠brida:
                    // 1. Se arrays tem mesmo tamanho, assume posicional (99% dos casos de diff de vers√£o).
                    // 2. Se tamanhos diferentes, tenta achar itens removidos/adicionados.

                    const arrA = [...valA];
                    const arrB = [...valB];

                    // Tenta ordenar se forem primitivos
                    if (arrA.length > 0 && isPrimitive(arrA[0])) {
                        arrA.sort();
                        arrB.sort();
                    }

                    // Se for array de Objetos e tiver mesmo tamanho, COMPARAR POSICIONALMENTE (√çndice a √çndice)
                    // Isso resolve o problema de detectar campo removido dentro de um objeto na mesma posi√ß√£o.
                    const maxLen = Math.max(arrA.length, arrB.length);
                    
                    for (let i = 0; i < maxLen; i++) {
                        if (i >= arrA.length) {
                            stats.added++;
                            html += `<div class="diff-node diff-added">+ ${JSON.stringify(arrB[i])}</div>`;
                        } else if (i >= arrB.length) {
                            stats.removed++;
                            html += `<div class="diff-node diff-removed">- ${JSON.stringify(arrA[i])}</div>`;
                        } else {
                            // Recurs√£o na mesma posi√ß√£o
                            html += generateDiffHtml(arrA[i], arrB[i], ignoreOrder);
                        }
                    }

                } else {
                    // Respeita ordem estrita
                    const maxLen = Math.max(valA.length, valB.length);
                    for (let i = 0; i < maxLen; i++) {
                        if (i >= valA.length) { 
                            stats.added++;
                            html += `<div class="diff-node diff-added">+ [${i}] ${JSON.stringify(valB[i])}</div>`;
                        } else if (i >= valB.length) { 
                            stats.removed++;
                            html += `<div class="diff-node diff-removed">- [${i}] ${JSON.stringify(valA[i])}</div>`;
                        } else {
                            html += generateDiffHtml(valA[i], valB[i], ignoreOrder);
                        }
                    }
                }
                
                html += '<span class="bracket">]</span></div>';
                
                // Limpeza: Se o HTML interno for vazio (apenas espa√ßos/quebras), retorna vazio
                if (html.replace(/<[^>]*>|\[|\]/g, '').trim() === '') return '';
                if (!html.includes('diff-')) return '';
                
                return html;
            }

            // 4. Objetos
            if (typeof valA === 'object') {
                let html = '<div class="diff-node"><span class="bracket">{</span>';
                
                // Pega todas as chaves √∫nicas
                const keysA = Object.keys(valA);
                const keysB = Object.keys(valB);
                const allKeys = new Set([...keysA, ...keysB]);
                const sortedKeys = Array.from(allKeys).sort();

                let hasDiff = false;

                sortedKeys.forEach(key => {
                    // Verifica exist√™ncia usando hasOwnProperty para seguran√ßa
                    const inA = Object.prototype.hasOwnProperty.call(valA, key);
                    const inB = Object.prototype.hasOwnProperty.call(valB, key);

                    if (!inA && inB) { // Nova chave em B
                        stats.added++;
                        hasDiff = true;
                        html += `<div class="diff-node diff-added">+ "${key}": ${JSON.stringify(valB[key])}</div>`;
                    } else if (inA && !inB) { // Chave removida de B (EXISTIA EM A, N√ÉO EXISTE EM B)
                        stats.removed++;
                        hasDiff = true;
                        html += `<div class="diff-node diff-removed">- "${key}": ${JSON.stringify(valA[key])}</div>`;
                    } else {
                        // Chave existe nos dois
                        const subDiff = generateDiffHtml(valA[key], valB[key], ignoreOrder);
                        if (subDiff) { // Se houve diferen√ßa interna
                            hasDiff = true;
                            html += `<div class="diff-node"><span class="key">"${key}":</span> ${subDiff}</div>`;
                        }
                    }
                });

                html += '<span class="bracket">}</span></div>';
                
                // Se n√£o houve nenhuma diferen√ßa detectada neste n√≠vel nem nos filhos, retorna vazio
                return hasDiff ? html : '';
            }

            return '';
        }

        // Utils
        function getType(v) {
            if (v === null) return 'null';
            if (Array.isArray(v)) return 'array';
            return typeof v;
        }

        function isPrimitive(v) {
            return v !== null && typeof v !== 'object' && typeof v !== 'function';
        }

    </script>
    <script>
        // --- HIST√ìRICO DE NAVEGA√á√ÉO ---
        (function() {
            const MAX_HISTORY = 10;
            const HISTORY_KEY = 'sap_docs_history';
            if (!window.location.pathname.endsWith('index.html')) {
                const pageTitle = document.title.split('-')[0].trim();
                const currentPage = { title: pageTitle, url: window.location.pathname.split('/').pop() };
                let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
                history = history.filter(h => h.url !== currentPage.url);
                history.unshift(currentPage);
                if (history.length > MAX_HISTORY) history.pop();
                localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            }
            const container = document.getElementById('history-list');
            if (container) {
                const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
                if (history.length === 0) container.innerHTML = '<div style="padding:5px 12px; font-size:0.75rem; color:#64748b;">Nenhum item recente.</div>';
                else { container.innerHTML = history.map(h => `<a href="${h.url}" class="history-link">${h.title}</a>`).join(''); }
            }
            window.clearHistory = function() { localStorage.removeItem(HISTORY_KEY); if(document.getElementById('history-list')) document.getElementById('history-list').innerHTML = ''; }
        })();
    </script>
</body>
</html>